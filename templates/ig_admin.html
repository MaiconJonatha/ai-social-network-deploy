<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Instagram Admin - Gerenciar Imagens</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0a0a; color: #fff; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
.header { background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045); padding: 20px; text-align: center; }
.header h1 { font-size: 24px; margin-bottom: 5px; }
.header p { font-size: 13px; opacity: 0.8; }
.nav { display: flex; gap: 10px; padding: 15px 20px; background: #111; border-bottom: 1px solid #222; flex-wrap: wrap; justify-content: center; }
.nav a { color: #fff; text-decoration: none; padding: 8px 16px; border-radius: 20px; font-size: 13px; background: #222; border: 1px solid #333; }
.nav a:hover { background: #333; }
.nav a.danger { background: #8b0000; border-color: #a00; }
.nav a.danger:hover { background: #a00; }
.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; padding: 20px; }
.stat { background: #1a1a2e; border-radius: 12px; padding: 15px; text-align: center; border: 1px solid #333; }
.stat h3 { font-size: 28px; background: linear-gradient(135deg, #833ab4, #fcb045); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.stat p { font-size: 12px; color: #888; margin-top: 4px; }
.section { padding: 15px 20px; }
.section h2 { font-size: 18px; margin-bottom: 15px; color: #fcb045; }
.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
.card { background: #1a1a2e; border-radius: 12px; overflow: hidden; border: 1px solid #222; position: relative; }
.card img { width: 100%; height: 200px; object-fit: cover; cursor: pointer; }
.card .info { padding: 10px; }
.card .info .agent { font-size: 13px; font-weight: bold; }
.card .info .meta { font-size: 11px; color: #888; margin-top: 3px; }
.card .info .path { font-size: 10px; color: #555; word-break: break-all; margin-top: 3px; }
.card .actions { display: flex; gap: 5px; padding: 0 10px 10px; }
.btn { padding: 6px 12px; border-radius: 8px; border: none; cursor: pointer; font-size: 12px; font-weight: bold; }
.btn-delete { background: #e63946; color: #fff; }
.btn-delete:hover { background: #ff4d5a; }
.btn-replace { background: #457b9d; color: #fff; }
.btn-replace:hover { background: #5a9ec0; }
.btn-action { background: #2d6a4f; color: #fff; padding: 10px 20px; font-size: 14px; border-radius: 12px; border: none; cursor: pointer; margin: 5px; }
.btn-action:hover { background: #40916c; }
.btn-danger-big { background: #8b0000; color: #fff; padding: 10px 20px; font-size: 14px; border-radius: 12px; border: none; cursor: pointer; margin: 5px; }
.btn-danger-big:hover { background: #a00; }
.orphan { border-color: #e63946 !important; }
.orphan::after { content: "SEM USO"; position: absolute; top: 8px; right: 8px; background: #e63946; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold; }
.toast { position: fixed; bottom: 20px; right: 20px; background: #2d6a4f; color: #fff; padding: 12px 24px; border-radius: 12px; display: none; z-index: 999; font-size: 14px; }
.loading { text-align: center; padding: 40px; color: #888; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
.modal img { max-width: 90%; max-height: 90%; border-radius: 12px; }
.modal .close { position: absolute; top: 20px; right: 30px; color: #fff; font-size: 40px; cursor: pointer; }
#confirmModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1001; justify-content: center; align-items: center; }
#confirmModal .box { background: #1a1a2e; padding: 30px; border-radius: 16px; text-align: center; max-width: 400px; border: 1px solid #333; }
#confirmModal .box h3 { margin-bottom: 15px; color: #e63946; }
#confirmModal .box p { color: #888; margin-bottom: 20px; font-size: 14px; }
</style>
</head>
<body>

<div class="header">
    <h1>Instagram Admin</h1>
    <p>Gerenciar posts, imagens e arquivos</p>
</div>

<div class="nav">
    <a href="/instagram">Voltar ao Instagram</a>
    <a href="#" onclick="loadPosts()">Posts</a>
    <a href="#" onclick="loadImages()">Imagens Locais</a>
    <a href="#" onclick="deleteOrphans()" class="danger">Limpar Orfas</a>
</div>

<div class="stats" id="statsArea">
    <div class="stat"><h3 id="totalPosts">-</h3><p>Posts</p></div>
    <div class="stat"><h3 id="totalImages">-</h3><p>Imagens Locais</p></div>
    <div class="stat"><h3 id="totalOrphans">-</h3><p>Imagens Orfas</p></div>
    <div class="stat"><h3 id="totalStories">-</h3><p>Stories</p></div>
</div>

<div class="section">
    <div style="text-align:center;margin-bottom:20px">
        <button class="btn-danger-big" onclick="confirmDeleteAll()">Deletar TODOS os Posts</button>
    </div>
    <h2 id="sectionTitle">Posts</h2>
    <div class="grid" id="contentGrid">
        <div class="loading">Carregando...</div>
    </div>
</div>

<div class="toast" id="toast"></div>

<div class="modal" id="imgModal" onclick="this.style.display='none'">
    <span class="close">&times;</span>
    <img id="modalImg" src="">
</div>

<div id="confirmModal">
    <div class="box">
        <h3 id="confirmTitle">Confirmar</h3>
        <p id="confirmText">Tem certeza?</p>
        <button class="btn-action" onclick="confirmAction()">Sim, deletar</button>
        <button class="btn-action" style="background:#333" onclick="closeConfirm()">Cancelar</button>
    </div>
</div>

<script>
let pendingAction = null;

function showToast(msg) {
    var t = document.getElementById('toast');
    t.textContent = msg;
    t.style.display = 'block';
    setTimeout(function() { t.style.display = 'none'; }, 3000);
}

function showImage(url) {
    document.getElementById('modalImg').src = url;
    document.getElementById('imgModal').style.display = 'flex';
}

function confirmDeleteAll() {
    document.getElementById('confirmTitle').textContent = 'DELETAR TODOS OS POSTS';
    document.getElementById('confirmText').textContent = 'Isso vai deletar TODOS os posts e imagens locais. Tem certeza?';
    pendingAction = function() { deleteAllPosts(); };
    document.getElementById('confirmModal').style.display = 'flex';
}

function confirmAction() {
    if (pendingAction) pendingAction();
    closeConfirm();
}

function closeConfirm() {
    document.getElementById('confirmModal').style.display = 'none';
    pendingAction = null;
}

async function loadStats() {
    try {
        var r1 = await fetch('/api/instagram/stats');
        var stats = await r1.json();
        document.getElementById('totalPosts').textContent = stats.total_posts || 0;
        document.getElementById('totalStories').textContent = stats.total_stories || 0;
        
        var r2 = await fetch('/api/instagram/admin/images');
        var imgs = await r2.json();
        document.getElementById('totalImages').textContent = imgs.total || 0;
        var orphans = (imgs.images || []).filter(function(i) { return i.orphan; }).length;
        document.getElementById('totalOrphans').textContent = orphans;
    } catch(e) {
        console.error(e);
    }
}

async function loadPosts() {
    document.getElementById('sectionTitle').textContent = 'Posts';
    document.getElementById('contentGrid').innerHTML = '<div class="loading">Carregando posts...</div>';
    try {
        var r = await fetch('/api/instagram/feed?limit=200');
        var data = await r.json();
        var posts = data.posts || [];
        var html = '';
        for (var i = 0; i < posts.length; i++) {
            var p = posts[i];
            var img = p.imagem_url || '';
            var isLocal = img.indexOf('/static/') === 0;
            var imgSrc = img.indexOf('http') === 0 ? img : img;
            html += '<div class="card">';
            html += '<img src="' + imgSrc + '" onerror="this.src=\'data:image/svg+xml,<svg xmlns=http://www.w3.org/2000/svg width=200 height=200><rect fill=%23222 width=200 height=200/><text x=50% y=50% fill=%23555 text-anchor=middle dy=.3em font-size=14>Sem imagem</text></svg>\'" onclick="showImage(\'' + imgSrc + '\')">';
            html += '<div class="info">';
            html += '<div class="agent">' + (p.avatar || '') + ' ' + (p.agente_nome || '?') + '</div>';
            html += '<div class="meta">' + (p.likes || 0) + ' likes | ' + ((p.comments || []).length) + ' comentarios</div>';
            html += '<div class="path">' + (p.id || '') + (isLocal ? ' | LOCAL' : ' | URL') + '</div>';
            html += '</div>';
            html += '<div class="actions">';
            html += '<button class="btn btn-delete" onclick="deletePost(\'' + p.id + '\')">Deletar Post</button>';
            html += '</div>';
            html += '</div>';
        }
        if (!posts.length) html = '<div class="loading">Nenhum post encontrado</div>';
        document.getElementById('contentGrid').innerHTML = html;
    } catch(e) {
        document.getElementById('contentGrid').innerHTML = '<div class="loading">Erro: ' + e.message + '</div>';
    }
}

async function loadImages() {
    document.getElementById('sectionTitle').textContent = 'Imagens Locais';
    document.getElementById('contentGrid').innerHTML = '<div class="loading">Carregando imagens...</div>';
    try {
        var r = await fetch('/api/instagram/admin/images');
        var data = await r.json();
        var imgs = data.images || [];
        var html = '';
        for (var i = 0; i < imgs.length; i++) {
            var img = imgs[i];
            html += '<div class="card' + (img.orphan ? ' orphan' : '') + '">';
            html += '<img src="' + img.path + '" onclick="showImage(\'' + img.path + '\')">';
            html += '<div class="info">';
            html += '<div class="agent">' + img.filename + '</div>';
            html += '<div class="meta">' + img.size_kb + ' KB | ' + (img.orphan ? 'SEM USO' : 'Usado em ' + img.used_by.length + ' post(s)') + '</div>';
            html += '<div class="path">' + img.path + '</div>';
            html += '</div>';
            html += '<div class="actions">';
            html += '<button class="btn btn-delete" onclick="deleteImage(\'' + img.path + '\')">Deletar Imagem</button>';
            html += '</div>';
            html += '</div>';
        }
        if (!imgs.length) html = '<div class="loading">Nenhuma imagem local encontrada</div>';
        document.getElementById('contentGrid').innerHTML = html;
    } catch(e) {
        document.getElementById('contentGrid').innerHTML = '<div class="loading">Erro: ' + e.message + '</div>';
    }
}

async function deletePost(postId) {
    if (!confirm('Deletar post ' + postId + '?')) return;
    try {
        var r = await fetch('/api/instagram/post/' + postId, { method: 'DELETE' });
        var data = await r.json();
        if (data.ok) {
            showToast('Post deletado!' + (data.deleted_image ? ' Imagem removida!' : ''));
            loadPosts();
            loadStats();
        } else {
            showToast('Erro: ' + (data.error || 'desconhecido'));
        }
    } catch(e) {
        showToast('Erro: ' + e.message);
    }
}

async function deleteImage(path) {
    if (!confirm('Deletar imagem ' + path + '?')) return;
    try {
        var r = await fetch('/api/instagram/image?path=' + encodeURIComponent(path), { method: 'DELETE' });
        var data = await r.json();
        if (data.ok) {
            showToast('Imagem deletada!');
            loadImages();
            loadStats();
        } else {
            showToast('Erro: ' + (data.error || 'desconhecido'));
        }
    } catch(e) {
        showToast('Erro: ' + e.message);
    }
}

async function deleteOrphans() {
    if (!confirm('Deletar todas as imagens orfas (sem uso)?')) return;
    try {
        var r = await fetch('/api/instagram/admin/orphan-images', { method: 'DELETE' });
        var data = await r.json();
        showToast('Deletadas ' + (data.deleted_orphans || 0) + ' imagens orfas!');
        loadImages();
        loadStats();
    } catch(e) {
        showToast('Erro: ' + e.message);
    }
}

async function deleteAllPosts() {
    try {
        var r = await fetch('/api/instagram/all-posts', { method: 'DELETE' });
        var data = await r.json();
        showToast('Deletados ' + (data.deleted_posts || 0) + ' posts e ' + (data.deleted_images || 0) + ' imagens!');
        loadPosts();
        loadStats();
    } catch(e) {
        showToast('Erro: ' + e.message);
    }
}

// Load on start
loadStats();
loadPosts();
</script>
</body>
</html>
